**å•ä¾‹æ¨¡å¼** æ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œ è®©ä½ èƒ½å¤Ÿä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œ å¹¶æä¾›ä¸€ä¸ªè®¿é—®è¯¥å®ä¾‹çš„å…¨å±€èŠ‚ç‚¹ã€‚æ¯”å¦‚çº¿ç¨‹æ± ã€å…¨å±€ç¼“å­˜ã€æµè§ˆå™¨ä¸­çš„ window å¯¹è±¡ç­‰ã€‚

ä¼˜ç‚¹ï¼š

1. å¯ä»¥ä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹
2. è·å¾—äº†ä¸€ä¸ªæŒ‡å‘è¯¥å®ä¾‹çš„å…¨å±€è®¿é—®èŠ‚ç‚¹
3. ä»…åœ¨é¦–æ¬¡è¯·æ±‚å•ä¾‹å¯¹è±¡æ—¶å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–

ç¼ºç‚¹ï¼š

1. è¿åäº†_å•ä¸€èŒè´£åŸåˆ™_ã€‚ è¯¥æ¨¡å¼åŒæ—¶è§£å†³äº†ä¸¤ä¸ªé—®é¢˜ï¼ˆ1.ä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼›2.ä¸ºå®ä¾‹æä¾›ä¸€ä¸ªå…¨å±€èŠ‚ç‚¹ï¼‰
2. è¯¥æ¨¡å¼åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹éœ€è¦è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œ é¿å…å¤šä¸ªçº¿ç¨‹å¤šæ¬¡åˆ›å»ºå•ä¾‹å¯¹è±¡

<img src="images/å•ä¾‹æ¨¡å¼.jpg" alt="å•ä¾‹æ¨¡å¼" style="zoom:50%;" />

ä¸€èˆ¬åˆ›å»ºæ–¹å¼ï¼š

```js
var Singleton = function(name) {
  this.name = name
}

Singleton.prototype.getName = function() {
  console.log(this.name)
}

Singleton.getInstance = (function() {
  var instance = null
  return function(name) {
    if (!instance) {
      instance = new Singleton(name)
    }
    return instance
  }
})()

var a = Singleton.getInstance('a')
var b = Singleton.getInstance('b')
console.log(a === b) // true=
```

è¿™ç§æ–¹å¼åˆ›å»ºå•ä¾‹ï¼Œåœ¨jsä¸­å¹¶ä¸ç®—å¥½ï¼Œå› ä¸ºè¿™å¢åŠ äº†è¿™ä¸ªç±»çš„ä¸é€æ˜æ€§ï¼Œä½¿ç”¨è€…å¿…é¡»çŸ¥é“è¿™ä¸ªç±»æ˜¯å•ä¾‹ï¼Œå¹¶ä¸”ä½¿ç”¨ `getInstance()` æ–¹æ³•æ¥åˆ›å»ºå•ä¾‹ã€‚

JSä¸­è¿˜æœ‰ä»¥ä¸‹å‡ ç§å®ç°æ–¹å¼ï¼š

## 1. é€æ˜çš„å•ä¾‹æ¨¡å¼

ç”¨æˆ·ä»åˆ›å»ºå¯¹è±¡çš„æ—¶å€™ï¼Œå¯ä»¥åƒä½¿ç”¨å…¶ä»–ä»»ä½•æ™®é€šå¯¹è±¡ä¸€æ ·ã€‚è¿™é‡Œæ‰€è°“é€æ˜ï¼Œæ˜¯æŒ‡é€šè¿‡ `new` çš„æ–¹å¼åˆ›å»ºå•ä¾‹ã€‚

æ¯”å¦‚ä¸‹é¢ `CreateDiv` å•ä¾‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯è´Ÿè´£åœ¨é¡µé¢ä¸­åˆ›å»ºå”¯ä¸€çš„divèŠ‚ç‚¹ï¼š

```js
var CreateDiv = (function() {
  var instance
  
  var CreateDiv = function(html) {
    if (instance) {
      return instance
    }
    this.html = html
    this.init()
    return instance = this
  }
  
  CreateDiv.prototype.init = function() {
    var div = document.createElement('div')
    div.innerHTML = this.html
    document.body.appendChild(div)
  }
  
  return CreateDiv
})()

var a = new CreateDiv('a')
var b = new CreateDiv('b')
console.log(a === b) // true
```

ä¸Šé¢å†™æ³•çš„ç¼ºç‚¹ï¼š

1. ä½¿ç”¨è‡ªæ‰§è¡Œçš„åŒ¿åå‡½æ•°ï¼ˆIIFEï¼‰ å’Œ é—­åŒ…ï¼Œ å¹¶ä¸”è®©åŒ¿åå‡½æ•°ç«‹å³è¿”å›çœŸæ­£çš„ **Singleton** æ„é€ æ–¹æ³•ï¼Œç¨‹åºé˜…è¯»èµ·æ¥æ¯”è¾ƒå¤æ‚
2. `CreateDiv` æ„é€ å‡½æ•°å®é™…è´Ÿè´£2ä»¶äº‹ï¼šåˆ›å»ºå¯¹è±¡å’Œæ‰§è¡Œåˆå§‹åŒ– `init` æ–¹æ³•ï¼Œè¿èƒŒ **å•ä¸€èŒè´£åŸåˆ™**



## 2. ä»£ç†æ¨¡å¼å®ç°å•ä¾‹

é€šè¿‡å¼•å…¥ä»£ç†ç±»çš„æ–¹å¼å¯ä»¥è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼š

é¦–å…ˆåœ¨ `CreateDiv` æ„é€ å‡½æ•°ä¸­ï¼ŒæŠŠè´Ÿè´£ç®¡ç†å•ä¾‹çš„ä»£ç ç§»é™¤å‡ºå»ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªæ™®é€šçš„åˆ›å»ºdivçš„ç±», ç„¶åå¼•å…¥ **ä»£ç†ç±»**

```js
var CreateDiv = function(html) {
	this.html = html
  this.init()
}

CreateDiv.prototype.init = function() {
  var div = document.createElement('div')
  div.innerHTML = this.html
  document.body.appendChild(div)
}

// ä»£ç†ç±»
var ProxySingletonCreateDiv = (function() {
  var instance
  return function(html) {
    if (!instance) {
      instance = new CreateDiv(html)
    }
    return instance
  }
})()

var a = new ProxySingletonCreateDiv('a')
var b = new ProxySingletonCreateDiv('b')
console.log(a === b) // true
```

ç°åœ¨æŠŠè´Ÿè´£ç®¡ç†å•ä¾‹çš„é€»è¾‘ç§»åˆ°äº†ä»£ç†ç±» `ProxySingletonCreateDiv` ä¸­ï¼Œè¿™æ · **CreateDiv æ™®é€š + ProxySingletonCreateDiv ç»„åˆè¾¾åˆ°å•ä¾‹çš„æ•ˆæœ**ï¼ˆè¿™ä¸ªä¾‹å­ä¹Ÿæ˜¯ **ç¼“å­˜ä»£ç†çš„åº”ç”¨ä¹‹ä¸€**ï¼‰



## 3. æƒ°æ€§å•ä¾‹

æ¯”å¦‚ä¸€ä¸ªå…¨å±€çš„Modalæ¡†ï¼Œåªæœ‰ç‚¹å‡»æŒ‰é’®çš„æ—¶å€™æ‰å°†å…¶æ·»åŠ åˆ°DOMæ–‡æ¡£ä¸­ï¼Œæ·»åŠ ä¹‹åï¼Œå†æ¬¡ç‚¹å‡»ä¸æ˜¯é‡æ–°åˆ›å»ºï¼Œè€Œæ˜¯ä½¿ç”¨ä¹‹å‰åˆ›å»ºå¥½çš„ä¹‹ååˆéšè—çš„é‚£ä¸ªmodalæ¡†ï¼š

```html
<button id="btn">
  æ˜¾ç¤ºmodal
</button>
```

æƒ°æ€§åŠ è½½ï¼š

```js
// åˆ©ç”¨é—­åŒ… + é«˜é˜¶å‡½æ•° + IIFE
var createLoginLayer = (function() {
  var div;
  return function() {
    if (!div) {
      div = document.createElement('div')
      div.innnerHTML = 'ç™»å½•Modal'
      div.style.display = 'none'
      document.body.appendChild(div)
    }
    return div
  }
})()

document.getElementById('btn').onclick = function() {
  var loginLayer = createLoginLayer()
  loginLayer.style.display = 'block'
}
```

ç¼ºç‚¹ï¼š

1. è¿åå•ä¸€èŒè´£ï¼Œåˆ›å»ºå¯¹è±¡å’Œç®¡ç†å•ä¾‹çš„é€»è¾‘éƒ½æ”¾åœ¨äº† `createLoginLayer` å¯¹è±¡å†…éƒ¨
2. æ— æ³•å¤ç”¨ï¼Œæ¯”å¦‚æƒ³è¦åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ `iframe`ï¼Œå‡ ä¹è¦å°†ä¸Šé¢çš„ä»£ç é‡å†™ä¸€é



## 4. âœ¨âœ¨âœ¨ é€šç”¨çš„æƒ°æ€§å•ä¾‹

ä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ **ä¸å˜çš„éƒ¨åˆ†éš”ç¦»å‡ºæ¥**ï¼Œç®¡ç†å•ä¾‹çš„é€»è¾‘å…¶å®å®Œå…¨å¯ä»¥æŠ½è±¡å‡ºæ¥ï¼šç”¨ä¸€ä¸ªå˜é‡æ¥åˆ¤æ–­æ˜¯å¦å·²ç»åˆ›å»ºè¿‡å¯¹è±¡äº†ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¸‹æ¬¡ç›´æ¥è¿”å›è¯¥å¯¹è±¡å³å¯ï¼š

âš¡ï¸âš¡ï¸âš¡ï¸

```js
// é—­åŒ… + é«˜é˜¶å‡½æ•° + apply
// resultç”¨æ¥ä¿å­˜fnçš„è®¡ç®—ç»“æœï¼Œå› ä¸ºresultåœ¨é—­åŒ…ä¸­ï¼Œå› æ­¤å®ƒä¸ä¼šè¢«é”€æ¯
var getSingleton = function(fn) {
  var result
  return function() {
    return result || (result = fn.apply(this, arguments))
  }
}
```

å…¶ä½™çš„ä¸šåŠ¡é€»è¾‘éƒ¨åˆ†ï¼š

æ¯”å¦‚åˆ›å»ºä¸€ä¸ªdiv

```js
var createLoginLayer = function() {
  var div = document.createElement('div')
  div.innnerHTML = 'ç™»å½•Modal'
  div.style.display = 'none'
  document.body.appendChild(div)
  return div
}

var createSingleLoginLayer = getSingleton(createLoginLayer)
document.getElementById('btn').onclick = function() {
  var loginLayer = createSingleLoginLayer()
  loginLayer.style.display = 'block'
}
```

å†æ¯”å¦‚åˆ›å»ºä¸€ä¸ªiframeï¼š

```js
var createIframe = function() {
  var iframe = document.createElement('iframe')
  document.body.appendChild(iframe)
  return iframe
}

var createSingleIframe = getSingleton(createIframe)
document.getElementById('btn').onclick = function() {
  var loginLayer = createSingleIframe()
  loginLayer.src = 'http://www.google.com'
}
```

**ä¸Šé¢å°†åˆ›å»ºå®ä¾‹å¯¹è±¡çš„èŒè´£å’Œç®¡ç†å•ä¾‹çš„èŒè´£åˆ†å¼€**ã€‚

Â ğŸŒˆğŸŒˆğŸŒˆ

å•ä¾‹å¯¹è±¡é™¤äº†åˆ›å»ºå¯¹è±¡å¤–ï¼Œè¿˜å¯ä»¥è®©å¯¹è±¡åªç»‘å®šä¸€æ¬¡äº‹ä»¶ï¼š

```js
var count = 0

var bindEvent = getSingleton(function() {
  count++
  document.getElementById('btn').onclick = function() {
    console.log('click')
  }
  console.log(`count: ${count}`)
  return true
})

var render = function() {
  console.log('å¼€å§‹æ¸²æŸ“åˆ—è¡¨')
  bindEvent()
}
render()
render()
render()

// æ‰“å°
"render"
"count: 1"
"render"
"render"
```

å¯ä»¥çœ‹åˆ°ï¼Œrenderå‡½æ•°å’ŒbindEventå‡½æ•°éƒ½åˆ†åˆ«æ‰§è¡Œäº†3æ¬¡ï¼Œä½†æ˜¯buttonå®é™…ä¸Šåªè¢«ç»‘å®šäº†ä¸€ä¸ªäº‹ä»¶



æ€»ç»“ï¼š

1. å•ä¾‹æ¨¡å¼æ˜¯ä¸€ç§ç®€å•ä½†éå¸¸å® ç”¨çš„æ¨¡å¼ï¼Œç‰¹åˆ«æ˜¯æƒ°æ€§å•ä¾‹æŠ€æœ¯ï¼Œåœ¨åˆé€‚çš„æ—¶å€™æ‰åˆ›å»ºå¯¹è±¡ï¼Œå¹¶ä¸”åªåˆ›å»ºå”¯ä¸€çš„ä¸€ä¸ª
2. å°†åˆ›å»ºå¯¹è±¡å’Œç®¡ç†å•ä¾‹çš„èŒè´£è¢«åˆ†å¸ƒåœ¨ä¸¤ä¸ªä¸åŒçš„æ–¹æ³•ä¸­ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ç»„åˆèµ·æ¥æ‰å…·æœ‰å•ä¾‹æ¨¡å¼çš„å¨åŠ›



æ‰©å±•é“¾æ¥ï¼š

1. [singleton - design patterns@refactoring guru](https://refactoringguru.cn/design-patterns/singleton)



2020/12/29  20:21:17

