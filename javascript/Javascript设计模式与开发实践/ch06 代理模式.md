**ä»£ç†æ¨¡å¼** æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ è®©ä½ èƒ½å¤Ÿæä¾›å¯¹è±¡çš„æ›¿ä»£å“æˆ–å…¶å ä½ç¬¦ã€‚ ä»£ç†æ§åˆ¶ç€å¯¹äºåŸå¯¹è±¡çš„è®¿é—®ï¼Œ å¹¶å…è®¸åœ¨å°†è¯·æ±‚æäº¤ç»™å¯¹è±¡å‰åè¿›è¡Œä¸€äº›å¤„ç†ã€‚

é€šä¿—ç†è§£å°±æ˜¯ï¼Œæœ¬æ¥Aè¦å®Œæˆçš„äº‹ï¼Œç”±äºæŸç§åŸå› ï¼Œå®ƒå°†è¿™ä»¶äº‹å§”æ‰˜ç»™Bæ¥å¤„ç†ã€‚

ä¼˜ç‚¹ï¼š

1. ä¿æŠ¤ä»£ç†ï¼Œç”¨äºæ§åˆ¶ä¸é€šæƒé™çš„å¯¹è±¡å¯¹ç›®æ ‡å¯¹è±¡çš„è®¿é—®
2. å¯ä»¥åœ¨å®¢æˆ·ç«¯æ¯«ä¸çŸ¥è§‰çš„æƒ…å†µä¸‹æ§åˆ¶æœåŠ¡å¯¹è±¡ï¼Œæ¯”å¦‚å°†ä»£ç†å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡æ¥å£è®¾ç½®ä¸ºä¸€è‡´ï¼Œè¿™æ ·å®¢æˆ·ç«¯ä½¿ç”¨æ—¶å°±ä¸ä¼šè§‰å¯Ÿåˆ°ä¸åŒ
3. å»¶è¿Ÿåˆå§‹åŒ–ï¼Œåœ¨å®é™…æœ‰éœ€è¦æ—¶å†åˆ›å»ºç›®æ ‡å¯¹è±¡ï¼Œè¾ƒå°‘å¼€é”€
4. ç¬¦åˆå°é—­åŸåˆ™

ç¼ºç‚¹ï¼š

1. å¯èƒ½éœ€è¦å¤šä¸ªæ¥å£ï¼Œå¢åŠ å¤æ‚æ€§

<img src="./images/ç»“æ„å‹-ä»£ç†æ¨¡å¼.jpg" alt="ç»“æ„å‹-ä»£ç†æ¨¡å¼" style="zoom:50%;" />

ä½¿ç”¨åœºæ™¯ï¼š

1. å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆè™šæ‹Ÿä»£ç†ï¼‰ï¼šæ¯”å¦‚å¯¹è±¡æ¯”è¾ƒå¤§ï¼Œæ— éœ€ä¸€å¼€å§‹å°±åˆå§‹åŒ–ï¼Œåªæœ‰åœ¨çœŸæ­£ä½¿ç”¨åˆ°æ—¶å†è¿›è¡Œåˆå§‹åŒ–
2. è®¿é—®æ§åˆ¶ï¼ˆä¿æŠ¤ä»£ç†ï¼‰ï¼šä»£ç†å¯ä»¥åœ¨å®¢æˆ·ç«¯æ»¡è¶³è¦æ±‚æ—¶ï¼Œå°†è¯·æ±‚è½¬å‘ç»™ç›®æ ‡å¯¹è±¡
3. è®°å½•æ—¥å¿—è¯·æ±‚ï¼ˆæ—¥å¿—è®°å½•ä»£ç†ï¼‰ï¼šåœ¨ä½¿ç”¨ç›®æ ‡å¯¹è±¡çš„å‰åï¼Œå¯ä»¥æ·»åŠ æ—¥å¿—
4. ç¼“å­˜è¯·æ±‚ç»“æœï¼ˆç¼“å­˜ä»£ç†ï¼‰ï¼šä»£ç†å¯å¯¹é‡å¤è¯·æ±‚æ‰€éœ€çš„ç›¸åŒç»“æœè¿›è¡Œç¼“å­˜ï¼Œ è¿˜å¯ä½¿ç”¨è¯·æ±‚å‚æ•°ä½œä¸ºç´¢å¼•ç¼“å­˜çš„é”®å€¼ï¼›é€‚ç”¨äºéœ€è¦ç¼“å­˜å®¢æˆ·è¯·æ±‚ç»“æœå¹¶å¯¹ç¼“å­˜ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†æ—¶ï¼Œ ç‰¹åˆ«æ˜¯å½“è¿”å›ç»“æœçš„ä½“ç§¯éå¸¸å¤§æ—¶ã€‚

ä¸€èˆ¬ç¤ºä¾‹ï¼Œæ¯”å¦‚Aé€èŠ±ç»™Cï¼Œä½†æ˜¯Bå’ŒCæ¯”è¾ƒè¦å¥½ï¼ŒBå¯ä»¥ä»£ç†Açš„è¯·æ±‚ï¼Œåœ¨Cå¿ƒæƒ…å¥½çš„æ—¶å€™ï¼Œå°†Açš„èŠ±é€ç»™Cï¼š

```js
const Flower = function() {}

// ç›®æ ‡å¯¹è±¡ï¼šè¢«ä»£ç†çš„ç±»
const A = {
  sendFlower: function(target) {
    const flower = new Flower()
    target.receiveFlower(flower)
  }
}

// ä»£ç†ç±»
// ä»£ç†Açš„è¯·æ±‚
const B = {
  receiveFlower: function(flower) {
    console.log('B receiveFlower')
    C.hasGoodMood(function() {
      C.receiveFlower(flower)
    })
  }
}


const C = {
  receiveFlower: function(flower) {
    console.log(`Cæ”¶åˆ°ğŸŒ¹ ` + flower)
  },
  hasGoodMood: function(fn){
    setTimeout(() => { // å‡è®¾Cè¿‡3sä¹‹åå¿ƒæƒ…å˜å¥½
      fn()
    }, 3000)
  }
}

// å®¢æˆ·ç«¯ä»£ç 
A.sendFlower(B)
```

ä»£ç†åœ¨jsä¸­çš„å…¶å®ƒåº”ç”¨ï¼š



## 1. è™šæ‹Ÿä»£ç†å®ç°å›¾ç‰‡é¢„åŠ è½½

ä¸ä½¿ç”¨ä»£ç†ï¼š

```js
var myImage = (function() {
  let img = document.createElement('img')
  document.body.appendChild(img)
  let image = new Image()
  image.onload = function() {
    // ç½‘ç»œå›¾ç‰‡åŠ è½½å®Œæˆåï¼Œå°†å ä½å›¾æ›¿æ¢
    img.src = image.src
  }
  
  return {
    setSrc: function(src) {
      img.src = './placeholder.jpg' // ä½¿ç”¨å ä½å›¾
      image.src = src // åŠ è½½ç½‘ç»œå›¾ç‰‡
    }
  }
})()

// ä½¿ç”¨
myImage.setSrc('https://www.xx.dog.png')
```

è¿™æ ·å†™çš„ç¼ºç‚¹ï¼š

1. ç ´åäº†å•ä¸€èŒè´£çš„åŸåˆ™ï¼Œè¿™ä¸ªç±»æœ‰2ä¸ªåŠŸèƒ½ç‚¹ï¼š ç»™imgè®¾ç½®srcçš„åŒæ—¶è¿˜è¦è´Ÿè´£é¢„åŠ è½½å›¾ç‰‡ã€‚è¿™æ ·ä¼šå½¢æˆè€¦åˆï¼Œå‡è®¾MyImageä¹‹åä¸éœ€è¦å ä½å›¾çš„åŠŸèƒ½ï¼Œåˆ™éœ€è¦æ›´æ”¹æºç ï¼Œä¸ç¬¦åˆå¼€é—­åŸåˆ™

ä½¿ç”¨ä»£ç†çš„æ–¹å¼ï¼š

```js
let myImage = (function() {
  let img = document.createElement('img')
  document.body.appendChild(img)
  
  return {
    setSrc: function(src) {
      img.src = src
    }
  }
})()

// ä»£ç†ç±»
let proxyImage = (function() {
  let image = new Image()
  image.onload = function() {
    // ä½¿ç”¨Targetç±»
    myImage.setSrc(this.src)
  }
  
  return {
    setSrc: function(src) {
      myImage.setSrc('./placeholder.jpg')
      image.src = src
    }
  }
})()

// å®¢æˆ·ç«¯ä½¿ç”¨
proxyImage.setSrc('https://www.xx.dog.png')
```

é€šè¿‡ä»£ç†ç±» **é—´æ¥** çš„è®¿é—®äº†è¢«ä»£ç†çš„ç±»myImageï¼Œè¯·æ±‚å®¢æˆ·ç«¯ä½¿ç”¨äº†ç›¸åŒçš„ `setSrc` æ–¹æ³•ï¼Œå¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œå¦å¤–è¿™ä¹Ÿç¬¦åˆå•ä¸€èŒè´£åŠŸèƒ½ã€‚

ä¸Šé¢çš„å†™æ³•ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå› ä¸ºjsä¸­å‡½æ•°ä¹Ÿæ˜¯å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥çš„è¿”å›å‡½æ•°ï¼š

```js
let myImage = (function() {
  let img = document.createElement('img')
  document.body.appendChild(img)
  
  return function(src) {
    img.src = src
  }
})()

// ä»£ç†ç±»
let proxyImage = (function() {
  let image = new Image()
  image.onload = function() {
    // ä½¿ç”¨Targetç±»
    myImage.setSrc(this.src)
  }
  
  return function(src) {
    myImage.setSrc('./placeholder.jpg')
    image.src = src
  }
})()

// å®¢æˆ·ç«¯ä½¿ç”¨
proxyImage('https://www.xx.dog.png')
```



## 2. è™šæ‹Ÿä»£ç†åˆå¹¶HTTPè¯·æ±‚

æ¯”å¦‚æœ‰å¦‚ä¸‹checkboxesï¼Œç”¨æˆ·å‹¾é€‰åï¼Œå°±å‘é€ä¸€ä¸ªè¯·æ±‚

```html
<input type="checkbox" id="1" /> 1
<input type="checkbox" id="2" /> 2
<input type="checkbox" id="3" /> 3
<input type="checkbox" id="4" /> 4
<input type="checkbox" id="5" /> 5
```

å‹¾é€‰å°±å‘é€è¯·æ±‚ï¼š

```js
const synchronousFile = function(id) {
	console.log(`å¼€å§‹åŒæ­¥æ–‡ä»¶ï¼Œid: ${id}`)	
}

const boxes = document.getElementByTagName('input[type="checkbox"]')
for (let i, c; c = boxes[i]; i++) {
  c.onclick = function() {
    if (this.checked) {
      synchronousFile(this.id)
    }
  }
}
```

è¿™æ ·çš„ç¼ºç‚¹æ˜¯ï¼Œä¼šé€ æˆå¤§é‡çš„è¯·æ±‚ï¼Œå¦‚æœéœ€æ±‚å…è®¸ï¼Œå°†æ‰€æœ‰çš„å‹¾é€‰é¡¹ç›®ä¸€èµ·æ‰“åŒ…è¯·æ±‚ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»£ç†ç±»å®Œæˆï¼š

```js
const proxySynchronousFile = (function() {
  let cache = []; // ä¿å­˜ä¸€æ®µæ—¶é—´å†…éœ€è¦åŒæ­¥çš„ID
  let timer;
  
  return function(id) {
    cache.push(id)
    if (timer) { // ä¿è¯ä¸ä¼šè¦†ç›–å·²ç»å¯åŠ¨çš„å®šæ—¶å™¨
      return
    }
    
    timer = setTimeout(function() {
      synchronousFile(cache.join(',')) // 2sååŒæ­¥æ‰€æœ‰ID
      clearTimeout(timer)
      timer = null
      cache.length = 0 // æ¸…ç©ºIDé›†åˆ
    }, 2000)
  }
})

const boxes = document.getElementByTagName('input[type="checkbox"]')
for (let i, c; c = boxes[i]; i++) {
  c.onclick = function() {
    if (this.checked) {
      proxySynchronousFile(this.id)
    }
  }
}
```



##  3 âœ¨âœ¨âœ¨ç¼“å­˜ä»£ç†

ä»£ç†å¯å¯¹é‡å¤è¯·æ±‚æ‰€éœ€çš„ç›¸åŒç»“æœè¿›è¡Œç¼“å­˜ï¼Œå¯ä»¥å°†è¯·æ±‚å‚æ•°ä½œä¸ºç¼“å­˜çš„key

å‡è®¾ä¸‹é¢è®¡ç®—æ˜¯ä¸€ä¸ªå¾ˆè€—æ—¶çš„è®¡ç®—

```js
const compute = function() {
  console.log('å¼€å§‹è®¡ç®—')
  let a = 1
  let l = arguments.length
  for (let i = 0; i < l; i ++) {
    a *= arguments[i]
  }
  return a
}

// ä¸Šé¢çš„è€—æ—¶æ“ä½œå°†æ‰§è¡Œ2æ¬¡ å³ä½¿å‚æ•°å®Œå…¨ä¸€è‡´
compute(2, 3, 4)
compute(2, 3, 4)
```

ä½¿ç”¨ä»£ç†è¿›è¡Œç¼“å­˜ï¼š

```js
const proxyCompute = (function() {
  let cache = {}
  return function() {
    // ä½¿ç”¨ ',' å°†æ‰€æœ‰çš„å‚æ•°åˆå¹¶æˆä¸€ä¸ªå­—ç¬¦ä¸² ç”¨ä½œkey
    var args = Array.prototype.join.call(arguments, ',')
    
    if (args in cache) { // å¦‚æœå­˜åœ¨åœ¨ç¼“å­˜ä¸­
      return cache[args] // ç›´æ¥è¿”å›ç¼“å­˜çš„ç»“æœ
    }
    
    // å¦‚æœä¸åœ¨ç¼“å­˜ä¸­ï¼Œ åˆ™ä½¿ç”¨Targetçš„æ–¹æ³•ï¼›å¹¶å°†ç»“æœæ·»åŠ åˆ°ç¼“å­˜ä¸­
    return cache[args] = compute.apply(this, arguments)
  }
})()

// ä¸Šé¢çš„è€—æ—¶æ“ä½œåªæ‰§è¡Œ1æ¬¡
compute(2, 3, 4)
// ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–ç»“æœ
compute(2, 3, 4)
```

## 4. ä½¿ç”¨é«˜é˜¶å‡½æ•°åŠ¨æ€åˆ›å»ºä»£ç†

å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå·¥å‚å‡½æ•°ï¼ŒåŠ¨æ€çš„åˆ›å»ºä»£ç†ï¼š

```js
const createProxy = function(fn) {
  let cache = {}
  return function() {
    let args = Array.prototype.join.call(arguments, ',')
    if (args in cache) {
      return cache[args]
    }
    return cache[args] = fn.apply(this, arguments)
  }
}

const multProxy = createProxy(compute)
```



æ€»ç»“ï¼šä»£ç†æ¨¡å¼æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„æ¨¡å¼ï¼Œå…¶æœ¬è´¨å°±æ˜¯Aå§”æ‰˜Båšæœ¬è¯¥Aå®Œæˆçš„äº‹(**å®é™…ä¸ŠBä¸­è¿˜æ˜¯ä¼šä½¿ç”¨Aæä¾›çš„æ–¹æ³•å®Œæˆè¯¥äº‹æƒ…**)ï¼ŒBå¯ä»¥åœ¨å°†å®Œæˆä»»åŠ¡è½¬äº¤ç»™Aä¹‹å‰ï¼Œè‡ªå®šä¹‰ä¸€äº›é€»è¾‘ã€‚

å†™ä»£ç æ—¶ï¼Œå¯ä»¥ä¸å¿…ä½¿ç”¨ä»£ç†ï¼Œåªæœ‰å½“ç›´æ¥ä½¿ç”¨ç›®æ ‡å¯¹è±¡ä¸æ–¹ä¾¿æ—¶ï¼Œå†è€ƒè™‘ä½¿ç”¨ä»£ç†ã€‚

å¦å¤–ï¼ŒES6ä¸­æ·»åŠ äº†ä¸€ä¸ªåŸç”Ÿçš„ [Proxy](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy) ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒå¯¹å¯¹è±¡å®Œæˆæ›´å¤šä»£ç†å·¥ä½œï¼Œæ¯”å¦‚Vueå’ŒMobxä¸­å°±å……åˆ†åˆ©ç”¨è¿™ä¸ªç±»å‹ï¼Œå¯¹å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•è¿›è¡Œä»£ç†ï¼ŒåŠ¨æ€çš„ç›‘å¬å±æ€§çš„å˜åŒ–æˆ–æ–¹æ³•çš„è°ƒç”¨ç­‰ç­‰ã€‚



æ‰©å±•é˜…è¯»ï¼š

1. [ä»£ç†æ¨¡å¼ - ç»“æ„æ¨¡å¼@Refactoring guru](https://refactoringguru.cn/design-patterns/proxy)



2021/1/2 16:59:39

