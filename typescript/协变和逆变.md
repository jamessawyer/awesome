## 0ï¸âƒ£ ç»§æ‰¿å’Œé‡Œæ°æ›¿æ¢åŸåˆ™

åå˜ï¼ˆ`Covarance`ï¼‰å’Œ é€†å˜ ï¼ˆ`Contravariance`ï¼‰ä¸ä»…å­˜åœ¨äºtsä¸­ï¼Œå®ƒè¡¨ç¤º **ç±»å‹ï¼ˆ`types`ï¼‰å’Œå­ç±»å‹ï¼ˆ`subtypes`ï¼‰** ä¹‹é—´çš„å…³ç³»ã€‚

åœ¨ç†è§£è¿™2ä¸ªæ¦‚å¿µä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹ä¼ ç»Ÿé¢å‘å¯¹è±¡ä¸­çš„ **å¤šæ€ï¼ˆ`polymorphism`ï¼‰** çš„æ¦‚å¿µ: åœ¨é‡Œæ°æ›¿æ¢åŸåˆ™ä¸­ï¼Œå¯ä»¥ç”¨ä¸€ä¸ª **å­ç±»å‹å¯¹è±¡å¯ä»¥æ›¿æ¢çˆ¶ç±»å‹å¯¹è±¡ä½¿ç”¨**ã€‚ä¸¾ä¸ªğŸŒ°ï¼š



```typescript
class Animal {
  name: string
  constructor(name: string) {
    this.name = name
  }
}

class Dog extends Animal {
  breed: string
  constructor(name: string, breed: string) {
    super(name)
    this.breed = breed
  }
}

function animalName(animal: Animal) {
  console.log(animal.name)
}

// ä½¿ç”¨
const animal = new Animal('dog')
animalName(animal) // âœ…

// Dog <: Animal
// ä½¿ç”¨ å­ç±»å¯¹è±¡ æ›¿æ¢ çˆ¶ç±»å¯¹è±¡
const dog = new Dog('dog', 'husky')
animalName(dog) // âœ…



// Dog <: Animal
// Func2 <: Func1
Func1 = Dog => string
Func2 = Animal => string

function anything(fun: Func1) {}

anything(func2)
```





æœ‰äº†ä¸Šé¢æ¦‚å¿µåï¼Œå…ˆå®šä¹‰ä¸€ä¸ªè¾…åŠ©å‡½æ•°æ¥å¸®åŠ©æˆ‘ä»¬åˆ†æ¸…çˆ¶å­ç±»å…³ç³»ï¼š

```typescript
// S æ˜¯å¦æ˜¯ P çš„å­ç±»
type IsSubtypeOf<S, P> => S extends P ? true : false
```

ä¸‹é¢ç”¨ `S <: P` è¡¨ç¤ºçˆ¶å­å…³ç³»ï¼Œ `S` å­ç±»ï¼Œ `P` çˆ¶ç±»ã€‚

å®šä¹‰2ä¸ªç±»ï¼š

```typescript
class User {
  name: string
  constructor(name: string) {
    this.name = name
  }
}

class Admin extends User {
  isSuperAdmin: boolean
  constructor(name: string, isSuperAdmin: boolean) {
    super(name)
    this.isSuperAdmin = isSuperAdmin
  }
}

// Admin ç»§æ‰¿ User å› æ­¤ Admin <: User
type T = IsSubtypeOf<Admin, User> // true âœ…
```



æ¥ä¸‹æ¥å†æ¥çœ‹åå˜é€†å˜ï¼š



## 1ï¸âƒ£ åå˜ï¼ˆCovariantï¼‰

å®šä¹‰ï¼š **å¦‚æœå­˜åœ¨ `S <: P` å…³ç³»ï¼Œ å¹¶ä¸” `T<S> <: T<P>` å…³ç³»ä¹Ÿæˆç«‹ï¼Œåˆ™ç§° `T` æ˜¯åå˜**ã€‚ç‰¹ç‚¹æ˜¯ï¼š**çˆ¶å­ç±»å…³ç³»é¡ºåºç›¸åŒ**

typescriptä¸­æ»¡è¶³åå˜çš„ç±»å‹æœ‰ï¼š `Promise<V> & Record<k, V> & Map<K, v>`:

```typescript
// Admin <: User
// Promise åå˜
// Promise<Admin> <: Promise<User> âœ…
type PromiseT = IsSubtypeOf<Promise<Admin>, Promise<User>> // true æ­£ç¡®

// Record<string, Admin> <: Record<string, User> âœ…
type RecordT = IsSubtypeOf<Record<string, Admin>, Record<string, User>> // true

// Map<string, Admin> <: Map<string, User> âœ…
// MapOfAdmin <: MapOfUser
type MapOfAdmin = Map<string, Admin>
type MapOfUser = Map<string, User>
type MapT = IsSubtypeOf<MapOfAdmin, MapOfUser> // true
```





## 2ï¸âƒ£ é€†å˜ ï¼ˆContravarianceï¼‰

å®šä¹‰ï¼š  **å¦‚æœå­˜åœ¨ `S <: P` å…³ç³»ï¼Œ å¹¶ä¸” `T<P> <: T<S>` å…³ç³»ä¹Ÿæˆç«‹ï¼Œåˆ™ç§° `T` æ˜¯é€†å˜**ã€‚ç‰¹ç‚¹æ˜¯ï¼š**çˆ¶å­ç±»å…³ç³»é¡ºåºåè½¬äº†**

æœ€å…¸å‹çš„ä¾‹å­å°±æ˜¯ **å‡½æ•°å‚æ•°**ï¼š

```typescript
type FuncParam = (p: Param) => void

type FuncAdmin = FuncParam<Admin>
type FuncUser = FuncParam<User>

// Admin <: User
// Func<User> <: Func<Admin>  ğŸš¨ çˆ¶å­å…³ç³»åè½¬äº†
type T = IsSubtypeOf<Func<User>, Func<Admin>> // true
```

å› ä¸ºå‡½æ•°å‚æ•°ä½ç½®å‘ç”Ÿäº†é€†å˜ï¼Œæ‰€ä»¥å‡ºç°äº†  `Func<User> <: Func<Admin>`


## 3ï¸âƒ£ å‡½æ•°çš„å­ç±»

æ‰€è°“çš„å‡½æ•°å­ç±»ï¼Œæ˜¯æŒ‡ä¸€ä¸ªå‡½æ•°ç±»å‹æ˜¯å¦ä¸€ä¸ªå‡½æ•°ç±»å‹çš„å­ç±»ï¼›å‡½æ•°å­ç±»æ—¢åŒ…å«åå˜ï¼Œä¹ŸåŒ…å«é€†å˜ï¼š **å‚æ•°ä½ç½®å‘ç”Ÿé€†å˜ï¼Œè¿”å›å€¼ä½ç½®å‘ç”Ÿåå˜**

```typescript
type SubtypeFunc = (p: User) => '1' | '2'
type BaseFunc = (p: Admin) => string

// å‚æ•°ä½ç½® å‘ç”Ÿé€†å˜ï¼š User <: Admin  å…³ç³»é¢ å€’
// è¿”å›ç»“æœ å‘ç”Ÿåå˜ï¼š '1' | '2' <: string
// æœ€å SubtypeFunc <: BaseFunc
type T2 = IsSubtypeOf(SubtypeFunc, BaseFunc)
```

ç¤ºä¾‹ï¼š

```typescript
const admins: Admin[] = {
  new Admin('admin 1', fasle),
  new Admin('admin 2', true),
  new Admin('admin 3', false)
}

const users: User[] = {
  new User('user 1'),
  new User('user 2'),
  new User('user 3')
}

// Admin <: User
// Admin[] <: User[]
type PredictUser = (user: User) => boolean
type PredictAdmin = (admin: Admin) => boolean
// å› ä¸ºå‡½æ•°æ˜¯å‚æ•°ä½ç½®é€†å˜ï¼Œè¿”å›åå˜ï¼Œæ‰€ä»¥
// PredictUser <: PredictAdmin
// IsSubtypeOf(PredictUser, PredictAdmin) âœ…

const isSuperAdmin: PredictAdmin = (admin: Admin) => admin.isSuperAdmin
const isEndWith1: PredictUser = (user: User) => user.username.endsWith('1')
// å› ä¸º PredictUser <: PredictAdmin
// æ‰€ä»¥ isEndWith1 <: isSuperAdmin

// admin.fiter() éœ€è¦æ·»åŠ ä¸€ä¸ª PredictAdmin ç±»å‹
admin.filter(isSuperAdmin) // âœ…
// å› ä¸º PredictUser æ˜¯ PredictAdmin çš„å­ç±»å‹ï¼Œæ ¹æ®é‡Œæ°æ›¿æ¢åŸåˆ™ æ‰€ä»¥ä¼ å…¥ isEndWith1 ä¹Ÿok
admin.filter(isEndWith1)  // âœ…

// user.fiter() éœ€è¦æ·»åŠ ä¸€ä¸ª PredictUser ç±»å‹
users.filter(isEndWith1) // âœ…

// æ ¹æ®é‡Œæ°æ›¿æ¢åŸåˆ™ï¼Œä¸èƒ½å°†ä¸€ä¸ªçˆ¶ç±»å‹ä»˜ç»™å­ç±»å‹
// Error
users.filter(isSuperAdmin) // âŒ
```

## 4ï¸âƒ£ æ–‡ç« é“¾æ¥

æ¥æºï¼š

- [ğŸ‰ Covariance and Contravariance in TypeScript - Dmitri Pavlutin](https://dmitripavlutin.com/typescript-covariance-contravariance/)  å…³äºé€†å˜åå˜æœ€å¥½çš„ä¸€ç¯‡æ–‡ç« 

æ‰©å±•é˜…è¯»ï¼š

- [ğŸŒ° What are covariance and contravariance? - stepchowfun](https://www.stephanboyer.com/post/132/what-are-covariance-and-contravariance) ä¸¾äº†ä¸€ä¸ªå®é™…çš„ä¾‹å­è¯´æ˜tsçš„é€†å˜å’Œåå˜
- [tsåå˜ä¸é€†å˜ - æ·±å…¥ç†è§£typescript](https://jkchao.github.io/typescript-book-chinese/tips/covarianceAndContravariance.html#%E4%B8%80%E4%B8%AA%E6%9C%89%E8%B6%A3%E7%9A%84%E9%97%AE%E9%A2%98) ä¸Šæ–‡çš„ä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬



2022å¹´05æœˆ23æ—¥09:53:33
